#!/bin/bash

echo "ğŸ§  RepoClone Intelligence: Post-commit Template Validation"
echo "=========================================================="

# RepoClone Intelligence - Template Validation
# This hook ensures templates are complete and ready for deployment

COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B)

echo "ğŸ“ Commit: $COMMIT_HASH"
echo "ğŸ’¬ Message: $COMMIT_MSG"

# Log intelligence activity
echo "ğŸ“Š Logging intelligence activity..."
INTELLIGENCE_LOG=".intelligence/activity.log"
mkdir -p .intelligence

cat >> "$INTELLIGENCE_LOG" << EOF
$(date): Commit $COMMIT_HASH
Message: $COMMIT_MSG
Files changed: $(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH)
Structure validation: PASSED
Template completeness: CHECKING...
EOF

# Validate template completeness
echo "ğŸ“‹ Validating template completeness..."
TEMPLATE_VIOLATIONS=0

# Check each template
for template in backend-logic/project-templates/*/; do
    if [ -d "$template" ]; then
        template_name=$(basename "$template")
        echo "ğŸ” Checking template: $template_name"
        
        # Required files for each template
        required_files=("package.json" "README.md" "tsconfig.json")
        for file in "${required_files[@]}"; do
            if [ ! -f "$template$file" ]; then
                echo "âŒ Missing $file in $template_name"
                TEMPLATE_VIOLATIONS=$((TEMPLATE_VIOLATIONS + 1))
            fi
        done
        
        # Check for template-specific files
        if [[ "$template_name" == *"nextjs"* ]]; then
            if [ ! -f "$template/next.config.js" ]; then
                echo "âŒ Missing next.config.js in $template_name"
                TEMPLATE_VIOLATIONS=$((TEMPLATE_VIOLATIONS + 1))
            fi
        fi
        
        # Check for components directory
        if [ ! -d "$template/components" ] && [ ! -d "$template/src/components" ]; then
            echo "âŒ Missing components directory in $template_name"
            TEMPLATE_VIOLATIONS=$((TEMPLATE_VIOLATIONS + 1))
        fi
    fi
done

# Update intelligence log
if [ $TEMPLATE_VIOLATIONS -eq 0 ]; then
    echo "âœ… All templates are complete and ready for deployment"
    echo "Template completeness: PASSED" >> "$INTELLIGENCE_LOG"
else
    echo "âŒ $TEMPLATE_VIOLATIONS template violations found"
    echo "Template completeness: FAILED ($TEMPLATE_VIOLATIONS violations)" >> "$INTELLIGENCE_LOG"
fi

# Check for new projects at root level
echo "ğŸ“‹ Checking for new projects at root level..."
NEW_PROJECTS=$(find . -maxdepth 1 -type d -name "*App" -o -name "*Project" -o -name "*Site" | grep -v "^\.$" | grep -v "backend-logic" | grep -v "node_modules" | grep -v ".git")

if [ ! -z "$NEW_PROJECTS" ]; then
    echo "ğŸ‰ New projects detected at root level:"
    echo "$NEW_PROJECTS"
    echo "âœ… Projects are properly positioned (not inside backend-logic)"
    echo "New projects detected: $NEW_PROJECTS" >> "$INTELLIGENCE_LOG"
else
    echo "ğŸ“ No new projects detected in this commit"
fi

echo ""
echo "ğŸ§  RepoClone Intelligence Summary:"
echo "ğŸ¯ Template deployment system is active"
echo "ğŸ“Š Activity logged to .intelligence/activity.log"
echo "ğŸš€ Ready to deploy templates to other projects" 